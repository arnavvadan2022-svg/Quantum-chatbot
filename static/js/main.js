document.addEventListener('DOMContentLoaded', () => {
    const queryForm = document.getElementById('query-form');
    const queryInput = document.getElementById('query-input');
    const sendButton = document.getElementById('send-button');
    const sendText = document.getElementById('send-text');
    const loadingSpinner = document.getElementById('loading-spinner');
    const chatMessages = document.getElementById('chat-messages');

    // Focus input on load
    queryInput.focus();

    queryForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const query = queryInput.value.trim();
        if (!query) return;

        // Add user message
        addMessage(query, 'user');
        queryInput.value = '';

        // Show loading state
        setLoading(true);

        try {
            const response = await fetch('/api/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query }),
            });

            const data = await response.json();

            if (data.success) {
                console.log('Results breakdown:', data.debug);
                addStructuredMessage(data.structured_answer, data.sources, data.confidence, data.debug);
            } else {
                addMessage(data.error || 'An error occurred. Please try again.', 'bot', null, null, null, true);
            }
        } catch (error) {
            console.error('Error:', error);
            addMessage('Failed to get a response. Please check your connection and try again.', 'bot', null, null, null, true);
        } finally {
            setLoading(false);
            queryInput.focus();
        }
    });

    function addStructuredMessage(structuredAnswer, sources, confidence, debug) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot-message';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        if (structuredAnswer && structuredAnswer.main) {
            // Main definition
            const mainP = document.createElement('p');
            mainP.className = 'main-answer';
            mainP.innerHTML = structuredAnswer.main.content + ' ' +
                createInlineCitation(structuredAnswer.main.source, structuredAnswer.main.source_link);
            contentDiv.appendChild(mainP);

            // Key properties
            if (structuredAnswer.properties && structuredAnswer.properties.length > 0) {
                const propertiesTitle = document.createElement('h4');
                propertiesTitle.textContent = 'Key Properties';
                propertiesTitle.style.marginTop = '20px';
                propertiesTitle.style.marginBottom = '15px';
                propertiesTitle.style.fontSize = '1.1em';
                propertiesTitle.style.color = 'var(--text-primary)';
                propertiesTitle.style.fontWeight = '600';
                contentDiv.appendChild(propertiesTitle);

                const propertiesList = document.createElement('ul');
                propertiesList.className = 'properties-list';

                structuredAnswer.properties.forEach(prop => {
                    const li = document.createElement('li');
                    li.innerHTML = prop.content + ' ' +
                        createInlineCitation(prop.source, prop.source_link);
                    propertiesList.appendChild(li);
                });

                contentDiv.appendChild(propertiesList);
            }
        }

        // Debug info
        if (debug) {
            const debugDiv = document.createElement('div');
            debugDiv.className = 'debug-info';
            debugDiv.innerHTML = `ðŸ“Š Retrieved: ${debug.arxiv_count} arXiv papers + ${debug.web_count} web sources | Generated by: ${debug.generated_by}`;
            contentDiv.appendChild(debugDiv);
        }

        // Sources section
        if (sources && sources.length > 0) {
            const sourcesDiv = document.createElement('div');
            sourcesDiv.className = 'sources';

            const sourcesTitle = document.createElement('h4');
            sourcesTitle.textContent = `ðŸ“š All Sources (${sources.length}):`;
            sourcesDiv.appendChild(sourcesTitle);

            const sourcesList = document.createElement('div');
            sourcesList.className = 'sources-grid';

            sources.forEach(source => {
                const sourceItem = document.createElement('div');
                sourceItem.className = 'source-item';

                const link = document.createElement('a');
                link.href = source.link;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.textContent = source.title;

                const badge = document.createElement('span');
                badge.className = 'source-type';
                badge.textContent = source.type;
                badge.style.background = getSourceColor(source.type);

                sourceItem.appendChild(link);
                sourceItem.appendChild(badge);
                sourcesList.appendChild(sourceItem);
            });

            sourcesDiv.appendChild(sourcesList);
            contentDiv.appendChild(sourcesDiv);
        }

        // Confidence score
        if (confidence !== null) {
            const confidenceDiv = document.createElement('div');
            confidenceDiv.className = 'confidence-score';

            const confidencePercent = (confidence * 100).toFixed(1);
            let confidenceClass = 'low';
            if (confidence >= 0.8) confidenceClass = 'high';
            else if (confidence >= 0.6) confidenceClass = 'medium';

            confidenceDiv.classList.add(confidenceClass);
            confidenceDiv.textContent = `Confidence: ${confidencePercent}%`;
            contentDiv.appendChild(confidenceDiv);
        }

        messageDiv.appendChild(contentDiv);
        chatMessages.appendChild(messageDiv);

        // Smooth scroll to bottom
        chatMessages.scrollTo({
            top: chatMessages.scrollHeight,
            behavior: 'smooth'
        });
    }

    function createInlineCitation(sourceName, sourceLink) {
        const sourceCount = Math.floor(Math.random() * 3) + 1;
        return `<a href="${sourceLink}" target="_blank" rel="noopener noreferrer" class="inline-citation" style="background: ${getSourceColor(sourceName)}">${sourceName} +${sourceCount}</a>`;
    }

    function getSourceColor(sourceType) {
        const colors = {
            'arXiv': '#6366f1',
            'Wikipedia': '#10b981',
            'Quantum Knowledge Base': '#8b5cf6',
            'IBM Quantum': '#f59e0b',
            'Qiskit': '#ef4444',
            'Microsoft Quantum': '#06b6d4',
            'SerpAPI': '#ec4899',
            'Google': '#3b82f6',
            'Web': '#64748b'
        };
        return colors[sourceType] || '#64748b';
    }

    function addMessage(text, sender, sources = null, confidence = null, debug = null, isError = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        const textP = document.createElement('p');
        textP.textContent = text;

        if (isError) {
            textP.className = 'error-message';
        }

        contentDiv.appendChild(textP);
        messageDiv.appendChild(contentDiv);
        chatMessages.appendChild(messageDiv);

        // Smooth scroll to bottom
        chatMessages.scrollTo({
            top: chatMessages.scrollHeight,
            behavior: 'smooth'
        });
    }

    function setLoading(isLoading) {
        sendButton.disabled = isLoading;
        queryInput.disabled = isLoading;

        if (isLoading) {
            sendText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
        } else {
            sendText.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
        }
    }

    // Handle Enter key
    queryInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            queryForm.dispatchEvent(new Event('submit'));
        }
    });
});